<div class="vm-list-container">
  <div class="vm-list-header">
    <h1 id="vm-list-title">Virtual Machines</h1>
    <div class="header-actions">
      <a routerLink="/dashboard/vms/create" 
         class="btn btn-primary"
         role="button"
         aria-label="Create new virtual machine">
        <span class="btn-icon" aria-hidden="true">‚ûï</span>
        Create VM
      </a>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section" role="search" aria-labelledby="vm-list-title">
    <div class="search-box">
      <label for="vm-search" class="sr-only">Search virtual machines</label>
      <input 
        id="vm-search"
        type="text" 
        placeholder="Search VMs..." 
        (input)="onSearch($event)"
        class="search-input"
        aria-label="Search virtual machines by name"
        autocomplete="off"
      >
    </div>
    
    <div class="filters" role="group" aria-label="Filter virtual machines">
      <label for="status-filter" class="filter-label">Status:</label>
      <select id="status-filter" 
              [(ngModel)]="statusFilter" 
              (change)="onFilterChange()" 
              class="filter-select"
              aria-label="Filter by status">
        <option value="">All Statuses</option>
        <option [value]="VMStatus.RUNNING">Running</option>
        <option [value]="VMStatus.STOPPED">Stopped</option>
        <option [value]="VMStatus.PAUSED">Paused</option>
        <option [value]="VMStatus.ERROR">Error</option>
      </select>

      <label for="os-filter" class="filter-label">OS Type:</label>
      <select id="os-filter" 
              [(ngModel)]="osTypeFilter" 
              (change)="onFilterChange()" 
              class="filter-select"
              aria-label="Filter by operating system type">
        <option value="">All OS Types</option>
        <option [value]="OSType.LINUX">Linux</option>
        <option [value]="OSType.WINDOWS">Windows</option>
        <option [value]="OSType.OTHER">Other</option>
      </select>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions" 
       *ngIf="selectedVMs.size > 0"
       role="region"
       aria-label="Bulk actions for selected virtual machines"
       aria-live="polite">
    <span class="selection-count" id="selection-status">
      {{ selectedVMs.size }} VM(s) selected
    </span>
    <div class="bulk-buttons" role="group" aria-labelledby="selection-status">
      <button (click)="bulkStart()" 
              class="btn btn-success btn-sm"
              [attr.aria-label]="'Start ' + selectedVMs.size + ' selected virtual machines'">
        Start
      </button>
      <button (click)="bulkStop()" 
              class="btn btn-warning btn-sm"
              [attr.aria-label]="'Stop ' + selectedVMs.size + ' selected virtual machines'">
        Stop
      </button>
      <button (click)="bulkDelete()" 
              class="btn btn-danger btn-sm"
              [attr.aria-label]="'Delete ' + selectedVMs.size + ' selected virtual machines'">
        Delete
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" 
       *ngIf="error$ | async as error"
       role="alert"
       aria-live="assertive">
    <span class="error-icon" aria-hidden="true">‚ö†Ô∏è</span>
    {{ error.message }}
    <button (click)="loadVMs()" 
            class="btn btn-link"
            aria-label="Retry loading virtual machines">
      Retry
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" 
       *ngIf="loading$ | async"
       role="status"
       aria-live="polite">
    <div class="loading-spinner" aria-hidden="true"></div>
    <span>Loading VMs...</span>
  </div>

  <!-- VM Table -->
  <div class="vm-table-container" 
       *ngIf="!(loading$ | async)"
       role="region"
       aria-labelledby="vm-list-title">
    <table class="vm-table" 
           role="table"
           aria-label="Virtual machines list">
      <thead>
        <tr role="row">
          <th class="checkbox-col" scope="col">
            <input 
              type="checkbox" 
              [checked]="selectedVMs.size === ((vms$ | async)?.length || 0) && ((vms$ | async)?.length || 0) > 0"
              [indeterminate]="selectedVMs.size > 0 && selectedVMs.size < ((vms$ | async)?.length || 0)"
              (change)="selectAllVMs()"
              aria-label="Select all virtual machines"
            >
          </th>
          <th class="sortable" 
              (click)="onSort('name')"
              (keydown.enter)="onSort('name')"
              (keydown.space)="onSort('name')"
              tabindex="0"
              scope="col"
              [attr.aria-sort]="getSortDirection('name')"
              role="columnheader">
            Name
            <span class="sort-indicator" 
                  *ngIf="sortBy === 'name'"
                  aria-hidden="true">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>
          <th class="sortable" 
              (click)="onSort('status')"
              (keydown.enter)="onSort('status')"
              (keydown.space)="onSort('status')"
              tabindex="0"
              scope="col"
              [attr.aria-sort]="getSortDirection('status')"
              role="columnheader">
            Status
            <span class="sort-indicator" 
                  *ngIf="sortBy === 'status'"
                  aria-hidden="true">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
          </th>
          <th scope="col">OS Type</th>
          <th scope="col">Resources</th>
          <th scope="col">Server</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let vm of (vms$ | async); let i = index" 
            class="vm-row"
            role="row"
            [attr.aria-rowindex]="i + 1">
          <td class="checkbox-col" role="gridcell">
            <input 
              type="checkbox" 
              [checked]="selectedVMs.has(vm.id)"
              (change)="toggleVMSelection(vm.id)"
              [attr.aria-label]="'Select ' + vm.name"
            >
          </td>
          <td class="vm-name" role="gridcell">
            <a [routerLink]="['/dashboard/vms', vm.id]" 
               class="vm-link"
               [attr.aria-label]="'View details for ' + vm.name">
              {{ vm.name }}
            </a>
            <div class="vm-uuid">{{ vm.uuid }}</div>
          </td>
          <td role="gridcell">
            <span class="status-badge" 
                  [ngClass]="getStatusClass(vm.status)"
                  [attr.aria-label]="'Status: ' + vm.status">
              {{ vm.status }}
            </span>
          </td>
          <td role="gridcell">
            <span class="os-type">{{ vm.os_type }}</span>
            <div class="os-version" *ngIf="vm.os_version">{{ vm.os_version }}</div>
          </td>
          <td class="resources-col" role="gridcell">
            <div class="resource-item">
              <span class="resource-icon" aria-hidden="true">üñ•Ô∏è</span>
              <span [attr.aria-label]="vm.resources.cpu_cores + ' CPU cores'">
                {{ vm.resources.cpu_cores }} CPU
              </span>
            </div>
            <div class="resource-item">
              <span class="resource-icon" aria-hidden="true">üíæ</span>
              <span [attr.aria-label]="vm.resources.memory_mb + ' megabytes of RAM'">
                {{ vm.resources.memory_mb }} MB RAM
              </span>
            </div>
            <div class="resource-item">
              <span class="resource-icon" aria-hidden="true">üíø</span>
              <span [attr.aria-label]="vm.resources.disk_gb + ' gigabytes of disk space'">
                {{ vm.resources.disk_gb }} GB
              </span>
            </div>
          </td>
          <td role="gridcell">
            <div class="server-info" [attr.aria-label]="'Server: ' + vm.server.hostname + ' at ' + vm.server.ip_address">
              <div class="server-name">{{ vm.server.hostname }}</div>
              <div class="server-ip">{{ vm.server.ip_address }}</div>
            </div>
          </td>
          <td class="actions-col" role="gridcell">
            <div class="action-buttons" role="group" [attr.aria-label]="'Actions for ' + vm.name">
              <button 
                *ngIf="vm.status === VMStatus.STOPPED" 
                (click)="startVM(vm)" 
                class="btn btn-success btn-sm"
                [attr.aria-label]="'Start ' + vm.name"
                title="Start VM"
              >
                <span aria-hidden="true">‚ñ∂Ô∏è</span>
              </button>
              <button 
                *ngIf="vm.status === VMStatus.RUNNING" 
                (click)="stopVM(vm)" 
                class="btn btn-warning btn-sm"
                [attr.aria-label]="'Stop ' + vm.name"
                title="Stop VM"
              >
                <span aria-hidden="true">‚èπÔ∏è</span>
              </button>
              <a 
                [routerLink]="['/dashboard/vms', vm.id, 'console']" 
                class="btn btn-info btn-sm"
                [attr.aria-label]="'Open console for ' + vm.name"
                title="Console"
                *ngIf="vm.status === VMStatus.RUNNING"
              >
                <span aria-hidden="true">üñ•Ô∏è</span>
              </a>
              <a 
                [routerLink]="['/dashboard/vms', vm.id, 'edit']" 
                class="btn btn-secondary btn-sm"
                [attr.aria-label]="'Edit ' + vm.name"
                title="Edit"
              >
                <span aria-hidden="true">‚úèÔ∏è</span>
              </a>
              <button 
                (click)="deleteVM(vm)" 
                class="btn btn-danger btn-sm"
                [attr.aria-label]="'Delete ' + vm.name"
                title="Delete VM"
              >
                <span aria-hidden="true">üóëÔ∏è</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" 
         *ngIf="(vms$ | async)?.length === 0 && !(loading$ | async)"
         role="region"
         aria-labelledby="empty-title">
      <div class="empty-icon" aria-hidden="true">üíª</div>
      <h3 id="empty-title">No VMs Found</h3>
      <p>Get started by creating your first virtual machine.</p>
      <a routerLink="/dashboard/vms/create" 
         class="btn btn-primary"
         role="button"
         aria-label="Create your first virtual machine">
        Create VM
      </a>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * perPage + 1 }} to {{ Math.min(currentPage * perPage, total) }} of {{ total }} VMs
    </div>
    <div class="pagination-controls">
      <button 
        (click)="onPageChange(currentPage - 1)" 
        [disabled]="currentPage === 1"
        class="btn btn-secondary btn-sm"
      >
        Previous
      </button>
      
      <span class="page-numbers">
        <button 
          *ngFor="let page of [].constructor(totalPages); let i = index"
          (click)="onPageChange(i + 1)"
          [class.active]="currentPage === i + 1"
          class="btn btn-secondary btn-sm page-btn"
        >
          {{ i + 1 }}
        </button>
      </span>
      
      <button 
        (click)="onPageChange(currentPage + 1)" 
        [disabled]="currentPage === totalPages"
        class="btn btn-secondary btn-sm"
      >
        Next
      </button>
    </div>
  </div>
</div>